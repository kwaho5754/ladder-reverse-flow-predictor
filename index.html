<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‚¬ë‹¤ë¦¬ ë¸”ëŸ­ ì˜ˆì¸¡ ê²°ê³¼</title>
  <style>
    body { font-family: "Noto Sans KR", sans-serif; background: #f4f7ff; padding: 2rem; }
    h1 { font-size: 1.8rem; text-align: center; margin-bottom: 2rem; position: relative; }
    #round-info {
      position: absolute;
      top: 0; right: 1rem;
      font-size: 1rem; color: #444;
      background: rgba(255,255,255,0.8); padding: 0.3rem 0.8rem;
      border-radius: 0.6rem;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .summary-box {
      max-width: 1000px; margin: 0 auto 2rem auto;
      background: #fff; border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1); padding: 1rem;
    }
    .summary-box h2 { text-align: center; margin-bottom: 1rem; }
    .summary-row { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: space-around; }
    .summary-half { flex: 1; min-width: 480px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.6rem; border-bottom: 1px solid #ddd; text-align: left; font-size: 0.95rem; }
    th { background: #eef2ff; }
    .section { margin-bottom: 3rem; }
    .card-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .card {
      background: #fff; padding: 1rem; border-radius: 0.8rem;
      box-shadow: 0 0 8px rgba(0,0,0,0.1); width: 280px;
    }
    .card h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .card h4 { font-size: 0.95rem; margin-top: 0.8rem; margin-bottom: 0.4rem; }
    .card ol { padding-left: 1.2rem; }
    .card li { font-size: 0.9rem; margin-bottom: 0.4rem; }
  </style>
</head>
<body>
  <h1>
    ğŸ”® ì‚¬ë‹¤ë¦¬ ë¸”ëŸ­ ì˜ˆì¸¡ ê²°ê³¼
    <span id="round-info">ì˜ˆì¸¡ íšŒì°¨: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
  </h1>

  <div id="summary-1"></div>
  <div id="summary-2"></div>
  <div id="summary-3"></div>
  <div id="summary-4"></div>
  <div id="summary-5"></div>
  <div id="summary-6"></div>
  <div id="results"></div>

  <script>
    // ì˜ˆì¸¡ íšŒì°¨ í‘œì‹œ: ìµœì‹  ìˆœë²ˆ + 1
    async function loadLatestRound() {
      try {
        const res = await fetch('/latest_round');
        const data = await res.json();
        document.getElementById("round-info").textContent = `ì˜ˆì¸¡ íšŒì°¨: ${data.round}íšŒ`;
      } catch (e) {
        console.error("ì˜ˆì¸¡ íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
      }
    }

    const modes = [
      "3block_orig", "3block_flip_full", "3block_flip_start", "3block_flip_odd_even",
      "4block_orig", "4block_flip_full", "4block_flip_start", "4block_flip_odd_even"
    ];

    const limits = [1, 2, 3, 4, 5, 6];

    const transformLabel = {
      "orig": "ì›ë³¸", "flip_start": "ì‹œì‘ì  ë°˜ì „",
      "flip_odd_even": "í™€ì§ ë°˜ì „", "flip_full": "ì™„ì „ ëŒ€ì¹­"
    };

    function getModeKey(mode) {
      return mode.split("_")[0];
    }

    function getTransformKey(mode) {
      return mode.split("_").slice(1).join("_");
    }

    async function loadResults() {
      const resultContainer = document.getElementById("results");
      resultContainer.innerHTML = "";

      const topTrack = {}, bottomTrack = {}, topRounds = {}, bottomRounds = {};

      for (const limit of limits) {
        for (const mode of modes) {
          try {
            const res = await fetch(`/predict?mode=${mode}&limit=${limit}`);
            const data = await res.json();

            const topItem = data["ìƒë‹¨ê°’ë“¤"][limit - 1];
            const bottomItem = data["í•˜ë‹¨ê°’ë“¤"][limit - 1];

            if (topItem?.ê°’) {
              if (!topTrack[topItem.ê°’]) topTrack[topItem.ê°’] = [];
              topTrack[topItem.ê°’].push({ ìˆœë²ˆ: topItem.ìˆœë²ˆ });
              topRounds[topItem.ê°’] = (topRounds[topItem.ê°’] || 0) + 1;
            }

            if (bottomItem?.ê°’) {
              if (!bottomTrack[bottomItem.ê°’]) bottomTrack[bottomItem.ê°’] = [];
              bottomTrack[bottomItem.ê°’].push({ ìˆœë²ˆ: bottomItem.ìˆœë²ˆ });
              bottomRounds[bottomItem.ê°’] = (bottomRounds[bottomItem.ê°’] || 0) + 1;
            }
          } catch (e) {
            console.error("ì˜ˆì¸¡ ì‹¤íŒ¨", mode, limit, e);
          }
        }
      }

      const container = document.createElement("div");
      container.className = "summary-box";

      const row = document.createElement("div");
      row.className = "summary-row";

      const topBox = document.createElement("div");
      topBox.className = "summary-half";
      topBox.innerHTML = `<h2>ğŸ“Š ì˜ˆì¸¡ ì „ì²´ ìƒë‹¨ê°’ ìˆœë²ˆ ì¶”ì </h2>${renderTable(topTrack, topRounds)}`;

      const bottomBox = document.createElement("div");
      bottomBox.className = "summary-half";
      bottomBox.innerHTML = `<h2>ğŸ“Š ì˜ˆì¸¡ ì „ì²´ í•˜ë‹¨ê°’ ìˆœë²ˆ ì¶”ì </h2>${renderTable(bottomTrack, bottomRounds)}`;

      row.appendChild(topBox);
      row.appendChild(bottomBox);
      container.appendChild(row);
      resultContainer.appendChild(container);
    }

    function renderTable(trackMap, countMap) {
      const rows = Object.entries(trackMap).map(([val, arr]) => {
        const ìˆœë²ˆë“¤ = arr.map(obj => `ìˆœë²ˆ ${obj.ìˆœë²ˆ}`).join("<br>");
        return `<tr><td>${val}</td><td>${countMap[val]}</td><td>${ìˆœë²ˆë“¤}</td></tr>`;
      }).join("");

      return `
        <table>
          <thead><tr><th>ê°’</th><th>ì¶œí˜„íšŸìˆ˜</th><th>ìˆœë²ˆ ìƒì„¸</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    loadLatestRound();
    loadResults();
  </script>
</body>
</html>
